<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Chamados</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;margin:0;padding:10px;background:#f2f2f2}
#mainframe{max-width:950px;margin:auto;background:#fff;padding:12px;border-radius:6px}

/* ===== TÍTULO ===== */
.header-title{
  background:#0b5d3b;
  color:#fff;
  padding:14px;
  border-radius:6px;
  text-align:center;
  margin-bottom:10px;
}
.header-title h2{margin:0}

h3{text-align:center;margin:10px 0}

button{padding:6px 12px;margin:4px;font-size:13px;border:none;border-radius:4px;cursor:pointer}
.btn-nav{background:#6c757d;color:#fff}
.btn-save{background:#007bff;color:#fff}
.btn-txt{background:#28a745;color:#fff}

/* botão buscar azul claro */
.btn-buscar{background:#4da3ff;color:#fff}

#formPage,#chamadosPage,#consultaPage{display:none}
input,textarea{width:100%;padding:6px;margin-bottom:6px;border:1px solid #ccc;border-radius:4px}
textarea{height:70px}

table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#f0f0f0}

.card{background:#fff;padding:12px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.05);margin-bottom:12px}
.preview{max-height:220px;overflow:auto;border:1px solid #eee;padding:8px}

.small{font-size:12px;color:#555}
.found{color:green;font-weight:bold}
.notfound{color:#c0392b;font-weight:bold}

/* ===== CONSULTA SELO (LINHA ÚNICA) ===== */
.linha-consulta{
  display:flex;
  gap:6px;
  align-items:flex-end;
  flex-wrap:wrap;
}
.linha-consulta input{margin-bottom:0}

.c-patrimonio{width:130px}
.c-buscar{width:80px}
.c-modelo{width:120px}
.c-serial{width:140px}
.c-dep{width:180px}
.c-cc{width:120px}
</style>
</head>

<body>
<div id="mainframe">

<div class="header-title">
  <h2>Sistema de Chamados</h2>
</div>

<div style="text-align:center">
  <button class="btn-nav" onclick="abrirForm()">FORMULÁRIO</button>
  <button class="btn-nav" onclick="abrirChamados()">CHAMADOS</button>
  <button class="btn-nav" onclick="abrirConsulta()">CONSULTA SELO</button>
</div>

<!-- FORM -->
<div id="formPage">
<h3>Formulário</h3>
<input id="titulo" placeholder="Título">
<input id="solicitante" placeholder="Solicitante">
<input id="cc" placeholder="Centro de Custo">
<input id="unidade" placeholder="Unidade">
<input id="departamento" placeholder="Departamento">
<input id="contato" placeholder="Contato">
<input id="email" placeholder="Email">
<input id="previsao" placeholder="Previsão">
<textarea id="descricao" placeholder="Descrição"></textarea>
<input id="equipamento" placeholder="Equipamento">
<button class="btn-save">Salvar Chamado</button>
<button class="btn-txt" onclick="gerarTXT()">Gerar TXT</button>
</div>

<!-- CHAMADOS -->
<div id="chamadosPage">
<h3>Chamados</h3>
<table><tbody><tr><td>Conectado ao Google Sheets</td></tr></tbody></table>
</div>

<!-- CONSULTA -->
<div id="consultaPage">

<div class="card">
<input id="file" type="file" accept=".xlsx,.xls,.csv">
<div id="status" class="small">Nenhum arquivo carregado.</div>
</div>

<div class="card">

<div class="linha-consulta">
  <input id="patrimonioBusca" class="c-patrimonio" placeholder="Patrimônio">
  <button id="buscarBtn" class="btn-buscar c-buscar" disabled>Buscar</button>
  <input id="modeloOut" class="c-modelo" placeholder="Modelo" readonly>
  <input id="serialOut" class="c-serial" placeholder="Serial" readonly>
  <input id="depOut" class="c-dep" placeholder="Departamento" readonly>
  <input id="ccOut" class="c-cc" placeholder="CC" readonly>
</div>

<div id="msg" class="small" style="margin-top:6px"></div>

</div>

<div class="card">
<strong>Pré-visualização</strong>
<div class="preview" id="previewArea">Nenhum dado.</div>
</div>

</div>
</div>

<script>
/* ================== CONFIG ================== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwbU4lhBDsPbz-PFEgmHwhXLncUzeyxQjQKkjlXLv3LflWxWnODTDvUGCl_BYAkbNJJQQ/exec';

/* ================== NAVEGAÇÃO ================== */
const formPage = document.getElementById('formPage');
const chamadosPage = document.getElementById('chamadosPage');
const consultaPage = document.getElementById('consultaPage');

function abrirForm(){
  formPage.style.display='block';
  chamadosPage.style.display='none';
  consultaPage.style.display='none';
}
function abrirChamados(){
  formPage.style.display='none';
  chamadosPage.style.display='block';
  consultaPage.style.display='none';
  carregarChamados();
}
function abrirConsulta(){
  formPage.style.display='none';
  chamadosPage.style.display='none';
  consultaPage.style.display='block';
}
abrirForm();

/* ================== SALVAR CHAMADO ================== */
function salvarChamado(){
  const campos = [
    titulo, solicitante, cc, unidade, departamento,
    contato, email, previsao, descricao, equipamento
  ];

  for(const c of campos){
    if(!c.value.trim()){
      alert('Preencha todos os campos antes de salvar.');
      c.focus();
      return;
    }
  }

  const params = new URLSearchParams();
  params.append('titulo', titulo.value);
  params.append('solicitante', solicitante.value);
  params.append('cc', cc.value);
  params.append('unidade', unidade.value);
  params.append('departamento', departamento.value);
  params.append('contato', contato.value);
  params.append('email', email.value);
  params.append('previsao', previsao.value);
  params.append('descricao', descricao.value);
  params.append('equipamento', equipamento.value);

  fetch(WEB_APP_URL, {
    method:'POST',
    body:params
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==='ok'){
      alert('Chamado salvo com sucesso!');
      document
        .querySelectorAll('#formPage input, #formPage textarea')
        .forEach(el=>el.value='');
      abrirChamados();
    }else{
      alert('Erro: '+res.message);
    }
  })
  .catch(err=>alert('Erro ao enviar: '+err));
}

/* ================== CARREGAR CHAMADOS ================== */
function carregarChamados(){
  fetch(WEB_APP_URL)
    .then(r=>r.json())
    .then(data=>{
      const tbody = document.getElementById('listaChamados');
      if(!tbody) return;

      tbody.innerHTML='';
      data.forEach((row,i)=>{
        if(i===0) return;
        const tr=document.createElement('tr');
        row.forEach(col=>{
          const td=document.createElement('td');
          td.textContent=col;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    })
    .catch(()=>alert('Erro ao carregar chamados'));
}

/* ================== TXT ================== */
function gerarTXT(){
  let texto='';
  const labels=document.querySelectorAll('#formPage label');
  const fields=document.querySelectorAll('#formPage input, #formPage textarea');
  labels.forEach((l,i)=>{
    texto+=`${l.textContent}: ${fields[i].value}\n`;
  });
  const blob=new Blob([texto],{type:'text/plain'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download='chamado.txt';
  link.click();
}
</script>

</body>
</html>
