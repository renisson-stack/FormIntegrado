<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Chamados</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;margin:0;padding:10px;background:#fff}
#mainframe{max-width:950px;margin:auto;background:#fff;padding:12px;border-radius:6px}

.header-bar{
  background:#0b5d3b;
  color:#fff;
  padding:2px 6px;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}

.header-bar h2{
  margin:0;
  font-size:20px;
}

.header-buttons{
  display:flex;
  gap:8px;
}

.header-buttons .btn-nav{
  background:#6fcf97;
  color:#0b5d3b;
  font-weight:600;
}

.header-buttons .btn-nav:hover{
  background:rgba(255,255,255,0.25);
}

@media (max-width:600px){
  .header-bar{
    flex-direction:column;
    align-items:flex-start;
    gap:10px;
  }
  .header-buttons{
    width:100%;
    justify-content:space-between;
  }
}

h3{text-align:center;margin:10px 0}

button{padding:6px 12px;margin:4px;font-size:13px;border:none;border-radius:4px;cursor:pointer}
.btn-nav{background:#6c757d;color:#fff}
.btn-save{background:#007bff;color:#fff}
.btn-txt{background:#28a745;color:#fff}
.btn-buscar{background:#4da3ff;color:#fff}

#formPage,#chamadosPage,#consultaPage{display:none}
input,textarea{
  width:97%;
  padding:5px;
  margin-bottom:0;
  border:1px solid #ccc;
  border-radius:4px;
  font-size:13px;
}

input::placeholder{
  color:#9ca3af;
  font-style:italic;
}

textarea{
  height:55px;
  resize:vertical;
}

.campo-linha{
  display:flex;
  flex-direction:column;
  margin-bottom:6px;
}

.campo-linha label{
  margin-bottom:2px;
  font-weight:600;
  font-size:13px;
  text-align:left;
}

table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#f0f0f0}

.card{background:#fff;padding:12px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.05);margin-bottom:12px}
.preview{max-height:220px;overflow:auto;border:1px solid #eee;padding:8px}

.small{font-size:12px;color:#555}
.found{color:green;font-weight:bold}
.notfound{color:#c0392b;font-weight:bold}

.linha-consulta{
  display:flex;
  gap:6px;
  align-items:flex-end;
  flex-wrap:wrap;
}
.linha-consulta input{margin-bottom:0}

.c-patrimonio{width:130px}
.c-buscar{width:80px}
.c-modelo{width:120px}
.c-serial{width:140px}
.c-dep{width:180px}
.c-cc{width:120px}

.form-botoes{
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:10px;
}

@media (max-width:600px){
  .campo-linha{
    grid-template-columns: 1fr;
  }
  .form-botoes{
    justify-content:stretch;
  }
  .form-botoes button{
    width:100%;
  }
}
</style>
</head>
<body>
<div id="mainframe">

<div class="header-bar">
  <h2>Sistema de Chamados</h2>

  <div class="header-buttons">
    <button class="btn-nav" onclick="abrirForm()">Formulário</button>
    <button class="btn-nav" onclick="abrirChamados()">Chamados</button>
    <button class="btn-nav" onclick="abrirConsulta()">Consulta Selo</button>
    <button class="btn-nav" onclick="abrirPlanilha()">Planilha</button>
  </div>
</div>

<!-- FORM -->
<div id="formPage">

<div class="campo-linha">
  <label for="titulo">Título</label>
  <input id="titulo" type="text" placeholder="BRASKEM - RJ/SP - INC1051857 - SUBSTITUIÇÃO DE RÁDIO - BR RJ DUQUE DE CAXIAS PE9 - MANUTENÇÃO">
</div>

<div class="campo-linha">
  <label for="solicitante">Solicitante</label>
  <input id="solicitante" type="text">
</div>

<div class="campo-linha">
  <label for="login">Login</label>
  <input id="login" type="text">
</div>

<div class="campo-linha">
  <label for="cc">CC</label>
  <input id="cc" type="text">
</div>

<div class="campo-linha">
  <label for="unidade">Unidade</label>
  <input id="unidade" type="text" placeholder="RJ DUQUE DE CAXIAS PE9">
</div>

<div class="campo-linha">
  <label for="departamento">Departamento</label>
  <input id="departamento" type="text" placeholder="MANUTENÇÃO">
</div>

<div class="campo-linha">
  <label for="contato">Contato</label>
  <input id="contato" type="text">
</div>

<div class="campo-linha">
  <label for="email">Email</label>
  <input id="email" type="email">
</div>

<div class="campo-linha">
  <label for="previsao">Previsão de entrega</label>
  <input id="previsao" type="date">
</div>

<div class="campo-linha">
  <label for="descricao">Descrição</label>
  <input id="descricao" type="text">
</div>

<div class="campo-linha">
  <label for="equipamento">Equipamento</label>
  <input id="equipamento" type="text">
</div>

<div class="form-botoes">
  <button class="btn-save" onclick="salvarChamado()">Salvar Chamado</button>
  <button class="btn-txt" onclick="gerarTXT()">Gerar TXT</button>
</div>
</div>

<!-- CHAMADOS -->
<div id="chamadosPage">
<table>
  <thead>
    <tr>
      <th>Data</th>
      <th>Título</th>
      <th>Solicitante</th>
      <th>Login</th>
      <th>CC</th>
      <th>Unidade</th>
      <th>Departamento</th>
      <th>Contato</th>
      <th>Email</th>
      <th>Previsão de entrega</th>
      <th>Descrição</th>
      <th>Equipamento</th>
    </tr>
  </thead>
  <tbody id="listaChamados">
    <tr><td colspan="12">Conectado ao Google Sheets</td></tr>
  </tbody>
</table>
</div>

<!-- CONSULTA -->
<div id="consultaPage">

<div class="card">
<input id="file" type="file" accept=".xlsx,.xls,.csv">
<div id="status" class="small">Nenhum arquivo carregado.</div>
</div>

<div class="card">

<div class="linha-consulta">
  <input id="patrimonioBusca" class="c-patrimonio" placeholder="Patrimônio">
  <button id="buscarBtn" class="btn-buscar c-buscar" disabled>Buscar</button>
  <input id="modeloOut" class="c-modelo" placeholder="Modelo" readonly>
  <input id="serialOut" class="c-serial" placeholder="Serial" readonly>
  <input id="depOut" class="c-dep" placeholder="Departamento" readonly>
  <input id="ccOut" class="c-cc" placeholder="CC" readonly>
</div>

<div id="msg" class="small" style="margin-top:6px"></div>

</div>

<div class="card">
<strong>Pré-visualização</strong>
<div class="preview" id="previewArea">Nenhum dado.</div>
</div>

</div>
</div>

<script>
/* ================== CONFIG ================== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwqxSl1MiPwGyHpMR6FOCyFGay1oX_1wFHitiaW0-jyvoX08MOPbhk61w_XDOGwAuKYoA/exec';
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/SEU_ID_AQUI/edit'; // SUBSTITUA PELO ID DA SUA PLANILHA

/* ================== NAVEGAÇÃO ================== */
const formPage = document.getElementById('formPage');
const chamadosPage = document.getElementById('chamadosPage');
const consultaPage = document.getElementById('consultaPage');

function abrirForm(){
  formPage.style.display='block';
  chamadosPage.style.display='none';
  consultaPage.style.display='none';
}
function abrirChamados(){
  formPage.style.display='none';
  chamadosPage.style.display='block';
  consultaPage.style.display='none';
  carregarChamados();
}
function abrirConsulta(){
  formPage.style.display='none';
  chamadosPage.style.display='none';
  consultaPage.style.display='block';
}
function abrirPlanilha(){
  window.open(GOOGLE_SHEET_URL, '_blank');
}
abrirForm();

/* ================== FUNÇÃO PARA FORMATAR DATA ================== */
function formatarData(dataString) {
  if (!dataString) return '';
  
  // Se já estiver no formato DD/MM/YYYY, retorna como está
  if (dataString.includes('/')) {
    const partes = dataString.split('/');
    if (partes[0].length <= 2) {
      return dataString; // Já está em formato brasileiro
    }
  }
  
  // Tenta converter a data
  const data = new Date(dataString);
  
  // Verifica se é uma data válida
  if (isNaN(data.getTime())) {
    return dataString; // Retorna original se não conseguir converter
  }
  
  // Formata para DD/MM/YYYY
  const dia = String(data.getDate()).padStart(2, '0');
  const mes = String(data.getMonth() + 1).padStart(2, '0');
  const ano = data.getFullYear();
  
  return `${dia}/${mes}/${ano}`;
}

/* ====== CONSULTA SELO ====== */
const file=document.getElementById('file');
const buscarBtn=document.getElementById('buscarBtn');
const patrimonioBusca=document.getElementById('patrimonioBusca');
const depOut=document.getElementById('depOut');
const serialOut=document.getElementById('serialOut');
const modeloOut=document.getElementById('modeloOut');
const ccOut=document.getElementById('ccOut');
const msg=document.getElementById('msg');
const previewArea=document.getElementById('previewArea');

let dataRows=[],headers=[],colMap={};

const norm=t=>String(t||'').trim().toLowerCase();

file.addEventListener('change',e=>{
  const reader=new FileReader();
  reader.onload=ev=>{
    const wb=XLSX.read(ev.target.result,{type:'binary'});
    dataRows=[];
    wb.SheetNames.forEach(aba=>{
      XLSX.utils.sheet_to_json(wb.Sheets[aba],{defval:""})
      .forEach(r=>dataRows.push({...r,__aba:aba}))
    });
    headers=Object.keys(dataRows[0]||{});
    colMap={
      patrimonio:headers.find(h=>norm(h).includes('patrim')),
      modelo:headers.find(h=>norm(h).includes('model')),
      serial:headers.find(h=>norm(h).includes('serial')||norm(h).includes('serie')),
      departamento:headers.find(h=>norm(h).includes('depart')),
      cc:headers.find(h=>norm(h).includes('cc')||norm(h).includes('centro'))
    };
    buscarBtn.disabled=false;
    renderPreview();
  };
  reader.readAsBinaryString(e.target.files[0]);
});

function renderPreview(){
  let html='<table><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  dataRows.slice(0,10).forEach(r=>{
    html+='<tr>'+headers.map(h=>`<td>${r[h]}</td>`).join('')+'</tr>';
  });
  previewArea.innerHTML=html+'</table>';
}

buscarBtn.onclick=()=>{
  const r=dataRows.find(l=>norm(l[colMap.patrimonio])===norm(patrimonioBusca.value));
  if(!r){
    msg.innerHTML='<span class="notfound">Não encontrado</span>';
    modeloOut.value=serialOut.value=depOut.value=ccOut.value='';
    return;
  }
  modeloOut.value=r[colMap.modelo]||'';
  serialOut.value=r[colMap.serial]||'';
  depOut.value=r[colMap.departamento]||'';
  ccOut.value=r[colMap.cc]||'';
  msg.innerHTML=`<span class="found">Encontrado na aba: ${r.__aba}</span>`;
};

/* ================== SALVAR CHAMADO ================== */
function salvarChamado(){
  const campos = [
    titulo, solicitante, login, cc, unidade, departamento,
    contato, email, previsao, descricao, equipamento
  ];

  for(const c of campos){
    if(!c.value.trim()){
      alert('Preencha todos os campos antes de salvar.');
      c.focus();
      return;
    }
  }

  const params = new URLSearchParams();
  params.append('titulo', titulo.value);
  params.append('solicitante', solicitante.value);
  params.append('login', login.value);
  params.append('cc', cc.value);
  params.append('unidade', unidade.value);
  params.append('departamento', departamento.value);
  params.append('contato', contato.value);
  params.append('email', email.value);
  params.append('previsao', previsao.value);
  params.append('descricao', descricao.value);
  params.append('equipamento', equipamento.value);

  fetch(WEB_APP_URL, {
    method:'POST',
    body:params
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==='ok'){
      alert('Chamado salvo com sucesso!');
      document
        .querySelectorAll('#formPage input, #formPage textarea')
        .forEach(el=>el.value='');
      abrirChamados();
    }else{
      alert('Erro: '+res.message);
    }
  })
  .catch(err=>alert('Erro ao enviar: '+err));
}

/* ================== CARREGAR CHAMADOS ================== */
function carregarChamados(){
  fetch(WEB_APP_URL)
    .then(r=>r.json())
    .then(data=>{
      const tbody = document.getElementById('listaChamados');
      if(!tbody) return;

      tbody.innerHTML='';
      data.forEach((row,i)=>{
        if(i===0) return; // Pula cabeçalho
        
        const tr=document.createElement('tr');
        row.forEach((col, colIndex) => {
          const td=document.createElement('td');
          
          // Formata as colunas de data (coluna 0 = Data, coluna 9 = Previsão)
          if(colIndex === 0 || colIndex === 9) {
            td.textContent = formatarData(col);
          } else {
            td.textContent = col;
          }
          
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    })
    .catch(()=>alert('Erro ao carregar chamados'));
}

/* ================== TXT ================== */
function gerarTXT(){
  const tituloVal = document.getElementById('titulo').value.trim();
  
  if(!tituloVal){
    alert('Preencha o título antes de gerar o TXT');
    return;
  }
  
  let texto = `${tituloVal}\n`;
  texto += `Solicitante: ${solicitante.value}\n`;
  texto += `Login: ${login.value}\n`;
  texto += `CC: ${cc.value}\n`;
  texto += `Unidade: ${unidade.value}\n`;
  texto += `Departamento: ${departamento.value}\n`;
  texto += `Contato: ${contato.value}\n`;
  texto += `Email: ${email.value}\n`;
  texto += `Previsão de entrega: ${previsao.value}\n`;
  texto += `Descrição: ${descricao.value}\n`;
  texto += `Equipamento: ${equipamento.value}`;

  document.getElementById('txtPreview').value = texto;
  document.getElementById('modalTxt').style.display = 'flex';
}

function fecharModalTxt(){
  document.getElementById('modalTxt').style.display='none';
}

function copiarTxt(){
  const txt = document.getElementById('txtPreview');
  txt.select();
  document.execCommand('copy');
  alert('Texto copiado!');
}

function confirmarTXT(){
  const texto = document.getElementById('txtPreview').value;
  const tituloArquivo = document.getElementById('titulo').value.trim();
  const nomeArquivo = tituloArquivo.substring(0, 100) + '.txt';
  
  const blob = new Blob([texto], {type:'text/plain'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = nomeArquivo;
  link.click();
  fecharModalTxt();
}
</script>

<!-- ===== MODAL PREVIEW TXT ===== -->
<div id="modalTxt" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  z-index:999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    width:90%;
    max-width:500px;
    padding:12px;
    border-radius:6px;
  ">
    <h3>Pré-visualização do Chamado</h3>

    <textarea id="txtPreview" style="
      width:100%;
      height:220px;
      font-size:13px;
    "></textarea>

    <div style="text-align:right;margin-top:8px">
      <button class="btn-nav" onclick="fecharModalTxt()">Cancelar</button>
      <button class="btn-txt" onclick="copiarTxt()">Copiar</button>
      <button class="btn-save" onclick="confirmarTXT()">Gerar TXT</button>
    </div>
  </div>
</div>

</body>
</html>

